#!/bin/bash
# Run exploit logprob computation for all checkpoints
# Serves 4 checkpoints at a time in parallel, then computes logprobs
set -euo pipefail

CKPT_DIR="/mnt/ssd-1/david/rh-indicators/results/sft_checkpoints_eval/sft_openai_gpt-oss-20b-20260113-060036-8c90352/checkpoints"
PYTHON="/mnt/ssd-1/david/rh-indicators/venv-david-ord/bin/python"
OUTPUT_DIR="/mnt/ssd-1/david/rh-indicators/results/exploit_logprobs"
SCRIPT="/mnt/ssd-1/david/rh-indicators/scripts/compute_exploit_logprobs.py"

ALL_CHECKPOINTS=(1 6 15 25 44 76 100 228 330)
GPU_PAIRS=("0,1" "2,3" "4,5" "6,7")
BASE_PORT=8001

mkdir -p "$OUTPUT_DIR"

# Process in batches of 4
for ((batch_start=0; batch_start<${#ALL_CHECKPOINTS[@]}; batch_start+=4)); do
    batch=("${ALL_CHECKPOINTS[@]:$batch_start:4}")
    echo "=========================================="
    echo "Processing batch: ${batch[*]}"
    echo "=========================================="

    # Start vLLM servers
    PIDS=()
    PORTS=()
    for i in "${!batch[@]}"; do
        ckpt=${batch[$i]}
        gpus=${GPU_PAIRS[$i]}
        port=$((BASE_PORT + i))
        merged="$CKPT_DIR/checkpoint-${ckpt}_merged"

        if [ ! -d "$merged" ]; then
            echo "WARNING: $merged not found, skipping"
            continue
        fi

        # Skip if output already exists
        if [ -f "$OUTPUT_DIR/checkpoint-${ckpt}.jsonl" ]; then
            echo "Skipping checkpoint-${ckpt} (output exists)"
            continue
        fi

        echo "Starting vLLM for checkpoint-${ckpt} on port $port (GPUs $gpus)..."
        CUDA_VISIBLE_DEVICES=$gpus $PYTHON -m vllm.entrypoints.openai.api_server \
            --model "$merged" \
            --tensor-parallel-size 2 \
            --port $port \
            --trust-remote-code \
            --gpu-memory-utilization 0.7 \
            --max-num-seqs 16 \
            --max-model-len 4096 \
            > "/tmp/vllm_exploit_ckpt${ckpt}.log" 2>&1 &
        PIDS+=($!)
        PORTS+=($port)
        echo "  PID: ${PIDS[-1]}"
    done

    if [ ${#PIDS[@]} -eq 0 ]; then
        echo "No servers to start in this batch"
        continue
    fi

    # Wait for servers to be ready
    echo "Waiting for ${#PIDS[@]} servers..."
    for port in "${PORTS[@]}"; do
        echo -n "  Port $port: "
        for attempt in $(seq 1 120); do
            if curl -s "http://localhost:$port/v1/models" >/dev/null 2>&1; then
                echo "ready (${attempt}x5s)"
                break
            fi
            if [ $attempt -eq 120 ]; then
                echo "TIMEOUT after 10min"
                # Show last few lines of log
                for ckpt in "${batch[@]}"; do
                    echo "=== Log for checkpoint-${ckpt} (last 10 lines) ==="
                    tail -10 "/tmp/vllm_exploit_ckpt${ckpt}.log" 2>/dev/null || true
                done
                # Kill all servers and exit
                for pid in "${PIDS[@]}"; do
                    kill $pid 2>/dev/null || true
                done
                exit 1
            fi
            sleep 5
        done
    done

    # Run exploit logprob computation in parallel
    COMPUTE_PIDS=()
    for i in "${!batch[@]}"; do
        ckpt=${batch[$i]}
        port=$((BASE_PORT + i))
        output="$OUTPUT_DIR/checkpoint-${ckpt}.jsonl"

        if [ -f "$output" ]; then
            continue
        fi

        # Check server is alive
        if ! curl -s "http://localhost:$port/v1/models" >/dev/null 2>&1; then
            echo "WARNING: Server on port $port not responding, skipping checkpoint-${ckpt}"
            continue
        fi

        echo "Computing logprobs for checkpoint-${ckpt}..."
        $PYTHON "$SCRIPT" \
            --base-url "http://localhost:$port/v1" \
            --output "$output" \
            --concurrency 16 \
            > "$OUTPUT_DIR/checkpoint-${ckpt}.log" 2>&1 &
        COMPUTE_PIDS+=($!)
    done

    # Wait for all computations to finish
    echo "Waiting for ${#COMPUTE_PIDS[@]} logprob computations..."
    for pid in "${COMPUTE_PIDS[@]}"; do
        wait $pid || echo "WARNING: Process $pid failed"
    done

    # Kill vLLM servers
    echo "Shutting down servers..."
    for pid in "${PIDS[@]}"; do
        kill $pid 2>/dev/null || true
    done
    sleep 5
    # Force kill any remaining
    for pid in "${PIDS[@]}"; do
        kill -9 $pid 2>/dev/null || true
    done
    sleep 2

    echo "Batch complete!"
    echo ""
done

echo "=========================================="
echo "All checkpoints processed!"
echo "Results in: $OUTPUT_DIR"
ls -la "$OUTPUT_DIR"/*.jsonl 2>/dev/null
echo "=========================================="
